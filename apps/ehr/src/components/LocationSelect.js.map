{"version":3,"file":"LocationSelect.js","sourceRoot":"","sources":["LocationSelect.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Autocomplete, AutocompleteRenderInputParams, TextField } from '@mui/material';\nimport Oystehr from '@oystehr/sdk';\nimport { Location, Schedule } from 'fhir/r4b';\nimport { ReactElement, useEffect, useMemo, useState } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { LocationWithWalkinSchedule } from 'src/pages/AddPatient';\nimport { isLocationVirtual } from 'utils';\nimport { dataTestIds } from '../constants/data-test-ids';\nimport { sortLocationsByLabel } from '../helpers';\nimport { useApiClients } from '../hooks/useAppClients';\n\ntype CustomFormEventHandler = (event: React.FormEvent<HTMLFormElement>, value: any, field: string) => void;\n\ninterface LocationSelectProps {\n  location?: LocationWithWalkinSchedule | undefined;\n  setLocation: (location: LocationWithWalkinSchedule | undefined) => void;\n  updateURL?: boolean;\n  storeLocationInLocalStorage?: boolean;\n  required?: boolean;\n  queryParams?: URLSearchParams;\n  handleSubmit?: CustomFormEventHandler;\n  renderInputProps?: Partial<AutocompleteRenderInputParams>;\n}\n\nenum LoadingState {\n  initial,\n  loading,\n  loaded,\n}\n\nexport default function LocationSelect({\n  queryParams,\n  location,\n  handleSubmit,\n  setLocation,\n  updateURL,\n  storeLocationInLocalStorage,\n  required,\n  renderInputProps,\n}: LocationSelectProps): ReactElement {\n  const { oystehr } = useApiClients();\n  const [locations, setLocations] = useState<LocationWithWalkinSchedule[]>([]);\n  const [loadingState, setLoadingState] = useState(LoadingState.initial);\n  const navigate = useNavigate();\n\n  useEffect(() => {\n    if (updateURL && localStorage.getItem('selectedLocation')) {\n      queryParams?.set('locationID', JSON.parse(localStorage.getItem('selectedLocation') ?? '')?.id ?? '');\n      navigate(`?${queryParams?.toString()}`);\n    }\n  }, [navigate, queryParams, updateURL]);\n\n  useEffect(() => {\n    async function getLocationsResults(oystehr: Oystehr): Promise<void> {\n      if (!oystehr) {\n        return;\n      }\n\n      setLoadingState(LoadingState.loading);\n\n      try {\n        const searchResults = (\n          await oystehr.fhir.search<Location | Schedule>({\n            resourceType: 'Location',\n            params: [\n              { name: '_count', value: '1000' },\n              { name: '_revinclude', value: 'Schedule:actor:Location' },\n            ],\n          })\n        ).unbundle();\n        const locationsResults = searchResults.filter(\n          (loc) => loc.resourceType === 'Location' && !isLocationVirtual(loc)\n        );\n        const mappedLocations: LocationWithWalkinSchedule[] = locationsResults.map((locationTemp) => {\n          const location = locationTemp as LocationWithWalkinSchedule;\n          const schedule = searchResults.find((scheduleTemp) => {\n            return (\n              scheduleTemp.resourceType === 'Schedule' &&\n              scheduleTemp.actor?.some((actor) => actor.reference === `Location/${location.id}`)\n            );\n          }) as Schedule;\n          return { ...location, walkinSchedule: schedule };\n        });\n        setLocations(mappedLocations);\n      } catch (e) {\n        console.error('error loading locations', e);\n      } finally {\n        setLoadingState(LoadingState.loaded);\n      }\n    }\n\n    if (oystehr && loadingState === LoadingState.initial) {\n      void getLocationsResults(oystehr);\n    }\n  }, [oystehr, loadingState]);\n\n  const getLocationLabel = (location: LocationWithWalkinSchedule): string => {\n    if (!location.name) {\n      console.log('Location name is undefined', location);\n      return 'Unknown Location';\n    }\n    return location.address?.state ? `${location.address.state.toUpperCase()} - ${location.name}` : location.name;\n  };\n\n  const options = useMemo(() => {\n    const allLocations = locations.map((location) => {\n      return {\n        label: getLocationLabel(location),\n        value: location.id,\n      };\n    });\n\n    return sortLocationsByLabel(allLocations as { label: string; value: string }[]);\n  }, [locations]);\n\n  const handleLocationChange = (event: any, newValue: any): void => {\n    const selectedLocation = newValue\n      ? locations.find((locationTemp) => locationTemp.id === newValue.value)\n      : undefined;\n    console.log('selected location in handle location change', selectedLocation);\n    setLocation(selectedLocation);\n\n    if (storeLocationInLocalStorage) {\n      if (newValue) {\n        localStorage.setItem('selectedLocation', JSON.stringify(selectedLocation));\n      } else {\n        localStorage.removeItem('selectedLocation');\n      }\n    }\n\n    if (handleSubmit) {\n      handleSubmit(event, selectedLocation, 'location');\n    }\n  };\n\n  return (\n    <Autocomplete\n      data-testid={dataTestIds.dashboard.locationSelect}\n      disabled={renderInputProps?.disabled}\n      value={\n        location\n          ? {\n              label: getLocationLabel(location),\n              value: location?.id,\n            }\n          : null\n      }\n      onChange={handleLocationChange}\n      isOptionEqualToValue={(option, tempValue) => option.value === tempValue.value}\n      options={options}\n      renderOption={(props, option) => {\n        return (\n          <li {...props} key={option.value}>\n            {option.label}\n          </li>\n        );\n      }}\n      fullWidth\n      renderInput={(params) => (\n        <TextField placeholder=\"Search location\" name=\"location\" {...params} label=\"Location\" required={required} />\n      )}\n    />\n  );\n}\n"]}