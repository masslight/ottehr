{"version":3,"file":"useEvolveUser.js","sourceRoot":"","sources":["useEvolveUser.tsx"],"names":[],"mappings":"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","sourcesContent":["import { useAuth0 } from '@auth0/auth0-react';\nimport { Operation } from 'fast-json-patch';\nimport { Practitioner } from 'fhir/r4b';\nimport { DateTime, Duration } from 'luxon';\nimport { useCallback, useEffect, useMemo } from 'react';\nimport { useMutation, useQuery } from 'react-query';\nimport {\n  getFullestAvailableName,\n  getPatchOperationForNewMetaTag,\n  getPractitionerNPIIdentifier,\n  initialsFromName,\n  PROJECT_NAME,\n  RoleType,\n  SyncUserResponse,\n  User,\n} from 'utils';\nimport { create } from 'zustand';\nimport { getUser } from '../api/api';\nimport { useApiClients } from './useAppClients';\nimport { useAuthToken } from './useAuthToken';\n\nexport interface EvolveUser extends User {\n  userName: string;\n  userInitials: string;\n  lastLogin: string | undefined;\n  hasRole: (role: RoleType[]) => boolean;\n}\n\ninterface EvolveUserState {\n  user?: User;\n  profile?: Practitioner;\n}\n\nconst useEvolveUserStore = create<EvolveUserState>()(() => ({}));\n\n// extracting it here, cause even if we use store - it will still initiate requests as much as we have usages of this hook,\n// so just to use this var as a synchronization mechanism - lifted it here\nlet _practitionerLoginUpdateStarted = false;\n\nexport default function useEvolveUser(): EvolveUser | undefined {\n  const { oystehr } = useApiClients();\n  const user = useEvolveUserStore((state) => state.user);\n  const profile = useEvolveUserStore((state) => state.profile);\n  const { user: auth0User } = useAuth0();\n\n  const isProviderHasEverythingToBeEnrolled = Boolean(\n    profile?.id &&\n      profile?.telecom?.find((phone) => phone.system === 'sms' || phone.system === 'phone')?.value &&\n      getPractitionerNPIIdentifier(profile)?.value &&\n      profile?.name?.[0]?.given?.[0] &&\n      profile?.name?.[0]?.family\n  );\n\n  const userRoles = user?.roles;\n  const hasRole = useCallback(\n    (role: RoleType[]): boolean => {\n      return userRoles?.find((r) => role.includes(r.name as RoleType)) != undefined;\n    },\n    [userRoles]\n  );\n\n  useGetUser();\n  useSyncPractitioner((data) => {\n    if (data.updated) {\n      console.log('Practitioner sync success');\n    }\n  });\n  const { refetch: refetchProfile } = useGetProfile();\n  const { isLoading: isPractitionerLastLoginBeingUpdated, mutateAsync: mutatePractitionerAsync } =\n    useUpdatePractitioner();\n\n  useEffect(() => {\n    if (user?.profile && !profile) {\n      void refetchProfile();\n    }\n  }, [profile, refetchProfile, user?.profile]);\n\n  useEffect(() => {\n    if (user && oystehr && profile && !isPractitionerLastLoginBeingUpdated && !_practitionerLoginUpdateStarted) {\n      _practitionerLoginUpdateStarted = true;\n      void mutatePractitionerAsync([\n        getPatchOperationForNewMetaTag(profile!, {\n          system: 'last-login',\n          code: DateTime.now().toISO() ?? 'Unknown',\n        }),\n      ]).catch(console.error);\n    }\n  }, [oystehr, isPractitionerLastLoginBeingUpdated, mutatePractitionerAsync, profile, user]);\n\n  useEffect(() => {\n    const lastLogin = auth0User?.updated_at;\n    if (lastLogin) {\n      const loginTime = DateTime.fromISO(lastLogin);\n      if (Math.abs(loginTime.diffNow('seconds').seconds) <= Duration.fromObject({ seconds: 5 }).seconds) {\n        localStorage.removeItem('selectedDate');\n      }\n    }\n  }, [auth0User?.updated_at]);\n\n  const { userName, userInitials, lastLogin } = useMemo(() => {\n    if (profile) {\n      const userName = getFullestAvailableName(profile) ?? `${PROJECT_NAME} Team`;\n      const userInitials = initialsFromName(userName);\n      const lastLogin = profile.meta?.tag?.find((tag) => tag.system === 'last-login')?.code;\n      return { userName, userInitials, lastLogin };\n    }\n    return { userName: `${PROJECT_NAME} team`, userInitials: initialsFromName(`${PROJECT_NAME} Team`) };\n  }, [profile]);\n\n  return useMemo(() => {\n    if (user) {\n      return {\n        ...user,\n        userName,\n        userInitials,\n        lastLogin,\n        profileResource: profile,\n        isProviderHasEverythingToBeEnrolled,\n        hasRole,\n      };\n    }\n    return undefined;\n  }, [hasRole, isProviderHasEverythingToBeEnrolled, lastLogin, profile, user, userInitials, userName]);\n}\n\n// const MINUTE = 1000 * 60; // For Credentials Sync\n// const DAY = MINUTE * 60 * 24; // For Credentials Sync\n\n// eslint-disable-next-line @typescript-eslint/explicit-function-return-type\nconst useGetUser = () => {\n  const token = useAuthToken();\n  const user = useEvolveUserStore((state) => state.user);\n\n  return useQuery(\n    ['get-user'],\n    async (): Promise<void> => {\n      try {\n        const user = await getUser(token!);\n        useEvolveUserStore.setState({ user: user as User });\n      } catch (error) {\n        console.error(error);\n      }\n    },\n    {\n      enabled: Boolean(token && !user),\n    }\n  );\n};\n\n// eslint-disable-next-line @typescript-eslint/explicit-function-return-type\nconst useGetProfile = () => {\n  const token = useAuthToken();\n  const user = useEvolveUserStore((state) => state.user);\n  const { oystehr } = useApiClients();\n\n  return useQuery(\n    ['get-practitioner-profile'],\n    async (): Promise<void> => {\n      try {\n        if (!user?.profile) {\n          useEvolveUserStore.setState({ profile: undefined });\n          return;\n        }\n\n        const [resourceType, resourceId] = (user?.profile || '').split('/');\n        if (resourceType && resourceId && resourceType === 'Practitioner') {\n          const practitioner = await oystehr?.fhir.get<Practitioner>({ resourceType, id: resourceId });\n          useEvolveUserStore.setState({ profile: practitioner });\n        }\n      } catch (e) {\n        console.error(`error fetching user's fhir profile: ${JSON.stringify(e)}`);\n        useEvolveUserStore.setState({ profile: undefined });\n      }\n    },\n    {\n      enabled: Boolean(token && oystehr),\n    }\n  );\n};\n\n// eslint-disable-next-line @typescript-eslint/explicit-function-return-type\nconst useSyncPractitioner = (_onSuccess: (data: SyncUserResponse) => void) => {\n  // console.log('Credentials sync is not enabled');\n  /**\n   * Credentials sync functionality -- Uncomment if you are synchronizing credentials from an external system\n  \n  const client = useOystehrAPIClient();\n  const token = useAuthToken();\n  const { oystehr } = useApiClients();\n  const queryClient = useQueryClient();\n  return useQuery(\n    ['sync-user', oystehr],\n    async () => {\n      if (!client) return undefined;\n      _practitionerSyncStarted = true;\n      const result = await client?.syncUser();\n      _practitionerSyncFinished = true;\n      if (result.updated) {\n        void queryClient.refetchQueries('get-practitioner-profile');\n      } else {\n        useEvolveUserStore.setState((state) => ({ profile: { ...(state.profile! || {}) } }));\n      }\n      return result;\n    },\n    {\n      onSuccess,\n      cacheTime: DAY,\n      staleTime: DAY,\n      enabled: Boolean(token && oystehr && oystehr.config.accessToken && !_practitionerSyncStarted),\n    }\n  );\n  */\n};\n\n// eslint-disable-next-line @typescript-eslint/explicit-function-return-type\nconst useUpdatePractitioner = () => {\n  const user = useEvolveUserStore((state) => state.user);\n  const { oystehr } = useApiClients();\n\n  return useMutation(\n    ['update-practitioner'],\n    async (patchOps: Operation[]): Promise<void> => {\n      try {\n        if (!oystehr || !user) return;\n\n        await oystehr.fhir.patch({\n          resourceType: 'Practitioner',\n          id: user.profile.replace('Practitioner/', ''),\n          operations: [...patchOps],\n        });\n      } catch (error) {\n        console.error(error);\n        throw error;\n      }\n    },\n    { retry: 3 }\n  );\n};\n"]}