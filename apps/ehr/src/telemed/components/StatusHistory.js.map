{"version":3,"file":"StatusHistory.js","sourceRoot":"","sources":["StatusHistory.tsx"],"names":[],"mappings":"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","sourcesContent":["import InfoOutlinedIcon from '@mui/icons-material/InfoOutlined';\nimport { Box, ClickAwayListener, Typography, useTheme } from '@mui/material';\nimport { DateTime } from 'luxon';\nimport { FC, useReducer } from 'react';\nimport { TelemedAppointmentStatusEnum, TelemedStatusHistoryElement } from 'utils';\nimport { diffInMinutes, getAppointmentWaitingTime } from '../utils';\nimport { AppointmentStatusChip } from './AppointmentStatusChip';\nimport { CustomTooltip } from './CustomTooltip';\n\ntype StatusHistoryTooltipProps = {\n  history: TelemedStatusHistoryElement[];\n  currentStatus: keyof typeof TelemedAppointmentStatusEnum;\n};\n\nconst initialTooltipState: { visible: false } | { triggeredBy: 'click' | 'hover'; visible: true } = {\n  visible: false,\n};\n\nfunction tooltipReducer(\n  state: typeof initialTooltipState,\n  action: 'OPEN_ON_CLICK' | 'CLOSE_ON_CLICK' | 'OPEN_ON_HOVER' | 'CLOSE_ON_LEAVE'\n): typeof initialTooltipState {\n  switch (action) {\n    case 'OPEN_ON_CLICK':\n      return state.visible === false || state.triggeredBy !== 'click' ? { visible: true, triggeredBy: 'click' } : state;\n    case 'OPEN_ON_HOVER':\n      return state.visible === false ? { visible: true, triggeredBy: 'hover' } : state;\n    case 'CLOSE_ON_CLICK':\n      return state.visible === true ? { visible: false } : state;\n    case 'CLOSE_ON_LEAVE':\n      return state.visible === true && state.triggeredBy === 'hover' ? { visible: false } : state;\n    default:\n      return state;\n  }\n}\n\nexport const StatusHistory: FC<StatusHistoryTooltipProps> = (props) => {\n  const { history, currentStatus } = props;\n  const theme = useTheme();\n\n  const [tooltipState, updateTooltip] = useReducer(tooltipReducer, initialTooltipState);\n  const closeTooltipOnClick = (): void => updateTooltip('CLOSE_ON_CLICK');\n  const closeTooltipOnLeave = (): void => updateTooltip('CLOSE_ON_LEAVE');\n  const openTooltipOnClick = (): void => updateTooltip('OPEN_ON_CLICK');\n  const openTooltipOnHover = (): void => updateTooltip('OPEN_ON_HOVER');\n\n  const currentTimeISO = new Date().toISOString();\n\n  return (\n    <ClickAwayListener onClickAway={closeTooltipOnClick}>\n      <Box\n        sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}\n        onMouseEnter={openTooltipOnHover}\n        onMouseLeave={closeTooltipOnLeave}\n      >\n        <StatusHistoryTimeCounter\n          history={history}\n          currentAppointmentStatus={currentStatus}\n          currentTimeISO={currentTimeISO}\n        />\n        <div>\n          <CustomTooltip\n            PopperProps={{\n              disablePortal: true,\n            }}\n            onClose={closeTooltipOnClick}\n            open={tooltipState.visible}\n            disableFocusListener\n            disableHoverListener\n            disableTouchListener\n            title={\n              <TooltipContent\n                history={history}\n                currentAppointmentStatus={currentStatus}\n                currentTimeISO={currentTimeISO}\n              />\n            }\n          >\n            <Box sx={{ display: 'flex', alignItems: 'center' }}>\n              <InfoOutlinedIcon\n                onClick={openTooltipOnClick}\n                fontSize=\"small\"\n                sx={{ color: theme.palette.text.secondary, cursor: 'pointer' }}\n              />\n            </Box>\n          </CustomTooltip>\n        </div>\n      </Box>\n    </ClickAwayListener>\n  );\n};\n\nconst StatusHistoryTimeCounter: FC<{\n  history: TelemedStatusHistoryElement[];\n  currentAppointmentStatus: keyof typeof TelemedAppointmentStatusEnum;\n  currentTimeISO: string;\n}> = (props) => {\n  const { history, currentAppointmentStatus, currentTimeISO } = props;\n\n  const totalTime = getTotalAppointmentTime(history, currentAppointmentStatus, currentTimeISO);\n\n  const appointmentStatus = TelemedAppointmentStatusEnum[currentAppointmentStatus];\n  const isStatusReady = appointmentStatus === TelemedAppointmentStatusEnum.ready;\n  const isStatusComplete = appointmentStatus === TelemedAppointmentStatusEnum.complete;\n  const isStatusCanceled = appointmentStatus === TelemedAppointmentStatusEnum.cancelled;\n\n  if (isStatusReady || isStatusComplete) {\n    return <Typography>{`${getAppointmentWaitingTime(history)} m`}</Typography>;\n  }\n\n  if (isStatusCanceled) {\n    return <Typography>{`${totalTime} m`}</Typography>;\n  }\n\n  const lastHistoryRecord = history.at(-1);\n  return (\n    <Typography>\n      <>\n        {diffInMinutes(\n          DateTime.fromISO(lastHistoryRecord?.end || currentTimeISO),\n          DateTime.fromISO(lastHistoryRecord?.start || currentTimeISO)\n        )}\n        m / {totalTime}m\n      </>\n    </Typography>\n  );\n};\n\nconst TooltipContent: FC<{\n  history: TelemedStatusHistoryElement[];\n  currentAppointmentStatus: keyof typeof TelemedAppointmentStatusEnum;\n  currentTimeISO: string;\n}> = (props) => {\n  const { history, currentAppointmentStatus, currentTimeISO } = props;\n\n  const appointmentStatus = TelemedAppointmentStatusEnum[currentAppointmentStatus];\n  const isStatusReady = appointmentStatus === TelemedAppointmentStatusEnum.ready;\n  // const isStatusComplete = appointmentStatus === TelemedAppointmentStatusEnum.complete;\n  // const isStatusCanceled = appointmentStatus === TelemedAppointmentStatusEnum.cancelled;\n\n  const appointmentTotalTime = getTotalAppointmentTime(history, currentAppointmentStatus, currentTimeISO);\n  const totalTime = isStatusReady ? getAppointmentWaitingTime(history) : appointmentTotalTime;\n\n  const composeHistoryElementText = (historyElement: TelemedStatusHistoryElement): string => {\n    const isCanceledEntry = historyElement.status === TelemedAppointmentStatusEnum.cancelled;\n    const isCompletedEntry = historyElement.status === TelemedAppointmentStatusEnum.complete;\n\n    if (isCanceledEntry || isCompletedEntry) {\n      return '';\n    }\n\n    const historyElementStartTime = historyElement.start;\n    if (!historyElementStartTime) {\n      return '';\n    }\n\n    return `${diffInMinutes(\n      DateTime.fromISO(historyElement.end || currentTimeISO),\n      DateTime.fromISO(historyElementStartTime)\n    )} mins`;\n  };\n\n  return (\n    <Box sx={{ p: 2, display: 'flex', flexDirection: 'column', gap: 1 }}>\n      {history.map((element, index) => (\n        <Box sx={{ display: 'flex', gap: 1 }} key={`${element.status}-${index}`}>\n          <Typography sx={{ minWidth: '60px' }}>{composeHistoryElementText(element)}</Typography>\n          <AppointmentStatusChip status={element.status} />\n        </Box>\n      ))}\n      <Typography sx={{ fontWeight: 500, mt: 1 }}>Total: {totalTime} mins</Typography>\n    </Box>\n  );\n};\n\nconst getTotalAppointmentTime = (\n  history: TelemedStatusHistoryElement[],\n  appointmentStatus: keyof typeof TelemedAppointmentStatusEnum,\n  currentTimeISO: string\n): number => {\n  const firstHistoryRecord = history.at(0);\n  const lastHistoryRecord = history.at(-1);\n\n  const firstRecordStartTime = firstHistoryRecord?.start;\n  if (!firstRecordStartTime) {\n    return 0;\n  }\n\n  const historyStartTime = DateTime.fromISO(firstRecordStartTime);\n  const currentTime = DateTime.fromISO(currentTimeISO);\n\n  if (appointmentStatus === TelemedAppointmentStatusEnum.complete) {\n    const onVideoHistoryRecord = history.find((element) => element.status === TelemedAppointmentStatusEnum['on-video']);\n    const videoEndTime = onVideoHistoryRecord?.end;\n    return videoEndTime ? diffInMinutes(DateTime.fromISO(videoEndTime), historyStartTime) : 0;\n  }\n\n  if (appointmentStatus === TelemedAppointmentStatusEnum.cancelled) {\n    const lastRecordStartTime = lastHistoryRecord?.start;\n    return lastRecordStartTime ? diffInMinutes(DateTime.fromISO(lastRecordStartTime), historyStartTime) : 0;\n  }\n\n  return diffInMinutes(currentTime, historyStartTime);\n};\n"]}