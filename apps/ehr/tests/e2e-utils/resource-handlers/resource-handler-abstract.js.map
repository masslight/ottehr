{"version":3,"file":"resource-handler-abstract.js","sourceRoot":"","sources":["resource-handler-abstract.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,oCAAyD;AAEzD,uDAAsD;AAEtD;IAAA;QAGU,iCAA4B,GAAqC,EAAE,CAAC;IA2C9E,CAAC;IAzCiB,yCAAO,GAAvB;;;;;4BACsB,qBAAM,IAAA,6BAAa,GAAE,EAAA;;wBAAnC,WAAW,GAAG,SAAqB;wBACzC,IAAI,CAAC,WAAW,GAAG,WAAW,CAAC;wBAC/B,IAAI,CAAC,SAAS,GAAG,IAAI,aAAO,CAAC;4BAC3B,WAAW,EAAE,WAAW;4BACxB,UAAU,EAAE,OAAO,CAAC,GAAG,CAAC,QAAQ;4BAChC,aAAa,EAAE,OAAO,CAAC,GAAG,CAAC,cAAc;yBAC1C,CAAC,CAAC;;;;;KACJ;IAEe,gDAAc,GAA9B,UAA+B,QAAsB;;;;;;;wBAEjC,qBAAM,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,EAAA;;wBAApD,OAAO,GAAG,SAA0C;wBAC1D,IAAI,OAAO,CAAC,EAAE,EAAE,CAAC;4BACf,OAAO,CAAC,GAAG,CAAC,uBAAM,QAAQ,CAAC,cAAc,CAAC,aAAU,EAAE,OAAO,CAAC,EAAE,CAAC,CAAC;4BAClE,IAAI,CAAC,4BAA4B,CAAC,IAAI,CAAC,EAAE,EAAE,EAAE,OAAO,CAAC,EAAE,EAAE,YAAY,EAAE,OAAO,CAAC,cAAc,CAAC,EAAE,CAAC,CAAC;4BAClG,sBAAO,OAAO,EAAC;wBACjB,CAAC;;;;wBAED,OAAO,CAAC,KAAK,CAAC,iBAAK,QAAQ,CAAC,cAAc,CAAC,iBAAc,EAAE,OAAK,CAAC,CAAC;;4BAEpE,sBAAO,SAAS,EAAC;;;;KAClB;IAEe,gDAAc,GAA9B,UAA+B,gBAAgD;;;;;;;wBAE3E,qBAAM,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,MAAM,CAAC,gBAAgB,CAAC,EAAA;;wBAAlD,SAAkD,CAAC;wBACnD,OAAO,CAAC,GAAG,CAAC,iBAAK,gBAAgB,CAAC,YAAY,sBAAY,gBAAgB,CAAC,EAAE,CAAE,CAAC,CAAC;;;;wBAEjF,OAAO,CAAC,KAAK,CAAC,iBAAK,gBAAgB,CAAC,YAAY,2BAAiB,GAAC,CAAE,CAAC,CAAC;;;;;;KAEzE;IAIK,kDAAgB,GAAtB;;;;;;8BAE8D,EAAjC,KAAA,IAAI,CAAC,4BAA4B;;;6BAAjC,CAAA,cAAiC,CAAA;wBAAjD,YAAY;wBACrB,qBAAM,IAAI,CAAC,cAAc,CAAC,YAAY,CAAC,EAAA;;wBAAvC,SAAuC,CAAC;;;wBADf,IAAiC,CAAA;;;;;;KAG7D;IACH,8BAAC;AAAD,CAAC,AA9CD,IA8CC;AA9CqB,0DAAuB","sourcesContent":["import Oystehr, { FhirDeleteParams } from '@oystehr/sdk';\nimport { FhirResource } from 'fhir/r4b';\nimport { getAuth0Token } from '../auth/getAuth0Token';\n\nexport abstract class ResourceHandlerAbstract {\n  protected apiClient!: Oystehr;\n  protected accessToken!: string;\n  private createdResourcesDeleteParams: FhirDeleteParams<FhirResource>[] = [];\n\n  protected async initApi(): Promise<void> {\n    const accessToken = await getAuth0Token();\n    this.accessToken = accessToken;\n    this.apiClient = new Oystehr({\n      accessToken: accessToken,\n      fhirApiUrl: process.env.FHIR_API,\n      projectApiUrl: process.env.AUTH0_AUDIENCE,\n    });\n  }\n\n  protected async createResource(resource: FhirResource): Promise<FhirResource | undefined> {\n    try {\n      const created = await this.apiClient.fhir.create(resource);\n      if (created.id) {\n        console.log(`üëè ${resource['resourceType']} created`, created.id);\n        this.createdResourcesDeleteParams.push({ id: created.id, resourceType: created['resourceType'] });\n        return created;\n      }\n    } catch (error) {\n      console.error(`‚ùå ${resource['resourceType']} not created`, error);\n    }\n    return undefined;\n  }\n\n  protected async deleteResource(fhirDeleteParams: FhirDeleteParams<FhirResource>): Promise<void> {\n    try {\n      await this.apiClient.fhir.delete(fhirDeleteParams);\n      console.log(`‚úÖ ${fhirDeleteParams.resourceType} deleted ${fhirDeleteParams.id}`);\n    } catch (e) {\n      console.error(`‚ùå ${fhirDeleteParams.resourceType} not deleted: ${e}`);\n    }\n  }\n\n  abstract setResources(): Promise<void>;\n\n  async cleanupResources(): Promise<void> {\n    // todo rewrite this as batch request\n    for (const argsToDelete of this.createdResourcesDeleteParams) {\n      await this.deleteResource(argsToDelete);\n    }\n  }\n}\n"]}